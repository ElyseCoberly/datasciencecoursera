See commented code for description of how the code works